<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us" xml:lang="en-us">
<head>
    <title>Pexip Health</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <meta name="robots" content="noindex, nofollow" />
    <script type="text/javascript" src="https://cklab-edges.ck-collab-engtest.com/static/webrtc/js/pexrtc.js"></script>
    <script type="text/javascript" src="webui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- For Chart.js -->
    <script type='text/javascript'>
    window.onload = function() {
        var url = window.location.href;
        var params = url.substr(url.indexOf("?")+1).split("&");
        var i;
        var qp = {};
        for (i=0;i<params.length;i++) {
            var kv = params[i].split("=");
            qp[kv[0]] = kv[1];
        }
        console.log(qp);

        var source = "";
        if ("join_pres" in qp) {
            source = "screen";
        }

        // Initialize with the provided parameters
        initialise("cklab-edges.ck-collab-engtest.com", qp['alias'], qp['bandwidth'], qp['name'], "", source);

        // Check if the video stream is active before showing the vitals dashboard
        checkVideoStream();
    }

    function checkVideoStream() {
        var videoElement = document.getElementById("video");
        var interval = setInterval(function() {
            if (videoElement.srcObject && videoElement.srcObject.active) {
                clearInterval(interval);
                document.getElementById("vitals-container").style.display = "block"; // Show the vitals dashboard
                populateVitals();
                startSpO2Graph();
                startEKGMonitor();
            }
        }, 500); // Check every 500ms
    }

    function populateVitals() {
        document.getElementById("bp").innerText = "120/80 mmHg";
        document.getElementById("spO2").innerText = "98%";
        document.getElementById("temp").innerText = "98.6Â°F";
        document.getElementById("height").innerText = "70 in";
        document.getElementById("weight").innerText = "150 lbs";
    }

    function startSpO2Graph() {
        var ctx = document.getElementById('spo2-chart').getContext('2d');
        var spO2Chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'SpO2 Level (%)',
                    borderColor: '#ff7273',
                    backgroundColor: 'rgba(255, 114, 114, 0.2)',
                    data: []
                }]
            },
            options: {
                scales: {
                    x: {
                        display: false // Hide x-axis labels
                    },
                    y: {
                        min: 90,
                        max: 100,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Update the chart with random data
        setInterval(function() {
            if (spO2Chart.data.labels.length >= 20) {
                spO2Chart.data.labels.shift();
                spO2Chart.data.datasets[0].data.shift();
            }
            var newSpO2 = Math.floor(Math.random() * (100 - 92 + 1)) + 92;
            spO2Chart.data.labels.push('');
            spO2Chart.data.datasets[0].data.push(newSpO2);
            spO2Chart.update();
        }, 1000); // Update every second
    }

    function startEKGMonitor() {
        var ekgCanvas = document.getElementById('ekg-monitor');
        var ctx = ekgCanvas.getContext('2d');
        var height = ekgCanvas.height;
        var width = ekgCanvas.width;
        var x = 0;
        var y = height / 2;
        var amplitude = height / 6;
        var frequency = 0.1;
        var phase = 0;

        function drawEKG() {
            ctx.clearRect(0, 0, width, height);
            ctx.beginPath();
            ctx.moveTo(x, y);

            for (var i = 0; i < width; i++) {
                var newY = height / 2 + amplitude * Math.sin(frequency * (i + phase));
                ctx.lineTo(i, newY);
            }

            ctx.strokeStyle = '#0eb3c7';
            ctx.lineWidth = 2;
            ctx.stroke();
            phase += 0.1;
            x += 1;

            if (x >= width) {
                x = 0;
            }

            requestAnimationFrame(drawEKG);
        }

        drawEKG();
    }
    </script>

    <meta name="robots" content="NONE,NOARCHIVE" />
    <style>
    #vitals-container {
        display: none; /* Hide initially */
        position: absolute;
        left: 0;
        top: 0;
        width: 350px; /* Adjust width as needed */
        height: 100%; /* Full height */
        background: #0a2136; /* Match background color */
        color: white; /* Text color */
        border-right: 2px solid #0eb3c7; /* Match border color */
        padding: 10px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        overflow: auto; /* Add scroll if content overflows */
    }

    #vitals-container h2 {
        color: #0eb3c7; /* Heading color */
    }

    #vitals-container p {
        margin: 10px 0;
    }

    .chart-container {
        margin: 20px 0;
    }

    .chart-container canvas {
        width: 100% !important; /* Make the canvas responsive */
        height: 300px; /* Adjust height */
    }

    #ekg-monitor {
        width: 100%;
        height: 300px;
        background-color: #0a2136;
        border: 1px solid #0eb3c7;
    }
    </style>
</head>

<body class="home">
<!-- Container -->
<div id="container" class="site">
    <!-- Header -->
    <header id="header" class="branding" role="banner">
        <!-- <img src="img/pexhealthlogo.png" alt="MAIN LOGO"> -->
        <!-- <h1>Connect</h1> -->
    </header>
    <!-- END Header -->

    <!-- Content -->
    <div id="vitals-container">
        <h2>Vitals Dashboard</h2>
        <div>
            <h3>Last Measurements</h3>
            <p>Blood Pressure: <span id="bp">N/A</span></p>
            <p>SpO2 Level: <span id="spO2">N/A</span></p>
            <p>Temperature (F): <span id="temp">N/A</span></p>
            <p>Height (in): <span id="height">N/A</span></p>
            <p>Weight (lbs): <span id="weight">N/A</span></p>
        </div>
        <div class="chart-container">
            <h3>Current Measurements</h3>
            <h4>SpO2 Level</h4>
            <canvas id="spo2-chart"></canvas>
        </div>
        <div class="chart-container">
            <h4>EKG Monitor</h4>
            <canvas id="ekg-monitor"></canvas>
        </div>
    </div>

    <!-- Existing Content -->
    <!-- (Rest of your existing HTML content) -->
</div>
<!-- END Container -->

</body>
</html>
